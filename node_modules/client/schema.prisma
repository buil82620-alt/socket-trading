// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Admin: tài khoản quản trị CMS
model Admin {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("admins")
}

model User {
  id                      Int       @id @default(autoincrement())
  email                   String    @unique
  passwordHash            String    @map("password_hash")
  transactionPasswordHash String?   @map("transaction_password_hash")
  isActive                Boolean   @default(true) @map("is_active")
  isBanned                Boolean   @default(false) @map("is_banned")
  isVerified              Boolean   @default(false) @map("is_verified")
  banReason               String?   @map("ban_reason")
  bannedAt                DateTime? @map("banned_at")
  lastLoginAt             DateTime? @map("last_login_at")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  wallets              Wallet[]
  orders               SpotOrder[]
  tradeFills           TradeFill[]
  contractPositions    ContractPosition[]
  ieoInvestments       IEOInvestment[]
  miningInvestments    MiningInvestment[]
  withdrawalRequests   WithdrawalRequest[]
  depositRequests      DepositRequest[]
  transfers            Transfer[]
  exchangeTransactions ExchangeTransaction[]
  conversations        Conversation[]
  verificationRequests VerificationRequest[]

  @@map("users")
}

// Wallet: số dư của user theo từng asset (USDT, BTC, ETH, ...)
model Wallet {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  asset     String // USDT, BTC, ETH, ...
  available Decimal  @db.Decimal(36, 18) // Số dư khả dụng
  locked    Decimal  @default(0) @db.Decimal(36, 18) // Số dư bị khóa (cho limit orders)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, asset])
  @@map("wallets")
}

// SpotOrder: lệnh đặt mua/bán
model SpotOrder {
  id             Int      @id @default(autoincrement())
  userId         Int      @map("user_id")
  symbol         String // BTCUSDT, ETHUSDT, ...
  side           String // BUY, SELL
  type           String // MARKET, LIMIT
  price          Decimal? @db.Decimal(36, 18) // null nếu MARKET
  quantity       Decimal  @db.Decimal(36, 18)
  filledQuantity Decimal  @default(0) @db.Decimal(36, 18) // Số lượng đã khớp
  status         String   @default("NEW") // NEW, PARTIALLY_FILLED, FILLED, CANCELED, REJECTED
  feeAsset       String?  @map("fee_asset") // Asset của phí (thường là USDT hoặc base asset)
  feeAmount      Decimal? @default(0) @map("fee_amount") @db.Decimal(36, 18)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  tradeFills TradeFill[]

  @@index([userId, status])
  @@index([symbol, status])
  @@map("spot_orders")
}

// TradeFill: lịch sử khớp lệnh
model TradeFill {
  id        Int      @id @default(autoincrement())
  orderId   Int      @map("order_id")
  userId    Int      @map("user_id")
  symbol    String // BTCUSDT, ETHUSDT, ...
  price     Decimal  @db.Decimal(36, 18)
  quantity  Decimal  @db.Decimal(36, 18)
  feeAsset  String   @map("fee_asset")
  feeAmount Decimal  @map("fee_amount") @db.Decimal(36, 18)
  side      String // BUY, SELL
  createdAt DateTime @default(now()) @map("created_at")

  order SpotOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([orderId])
  @@index([symbol, createdAt])
  @@map("trade_fills")
}

// ContractPosition: Binary options/futures positions
model ContractPosition {
  id             Int       @id @default(autoincrement())
  userId         Int       @map("user_id")
  symbol         String // BTCUSDT, ETHUSDT, ...
  side           String // BUY_UP, BUY_DOWN
  entryPrice     Decimal   @map("entry_price") @db.Decimal(36, 18)
  amount         Decimal   @db.Decimal(36, 18)
  duration       Int // Duration in seconds (30, 60, 90, ...)
  profitability  Decimal   @db.Decimal(36, 18) // Profitability percentage
  expectedProfit Decimal   @map("expected_profit") @db.Decimal(36, 18)
  expectedPayout Decimal   @map("expected_payout") @db.Decimal(36, 18)
  status         String    @default("OPEN") // OPEN, CLOSED, SETTLED
  exitPrice      Decimal?  @map("exit_price") @db.Decimal(36, 18) // Price when position closed
  actualProfit   Decimal?  @map("actual_profit") @db.Decimal(36, 18) // Actual profit/loss
  result         String? // WIN, LOSS (null if still open)
  createdAt      DateTime  @default(now()) @map("created_at")
  expiresAt      DateTime  @map("expires_at") // entryPrice time + duration
  closedAt       DateTime? @map("closed_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([status, expiresAt])
  @@map("contract_positions")
}

// IEOProduct: IEO Launchpad products
model IEOProduct {
  id            Int       @id @default(autoincrement())
  title         String
  symbol        String // EBUN, ETF, ...
  status        String    @default("UPCOMING") // UPCOMING, IN_PROGRESS, ENDED, CANCELLED
  totalSupply   Decimal   @map("total_supply") @db.Decimal(36, 18)
  currentRaised Decimal   @default(0) @map("current_raised") @db.Decimal(36, 18)
  pricePerToken Decimal   @map("price_per_token") @db.Decimal(36, 18) // Price in USDT
  startDate     DateTime  @map("start_date")
  endDate       DateTime? @map("end_date")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  investments IEOInvestment[]

  @@index([status])
  @@index([startDate, endDate])
  @@map("ieo_products")
}

// IEOInvestment: User investments in IEO products
model IEOInvestment {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  productId Int      @map("product_id")
  amount    Decimal  @db.Decimal(36, 18) // Amount invested in USDT
  tokens    Decimal  @db.Decimal(36, 18) // Tokens received
  status    String   @default("PENDING") // PENDING, CONFIRMED, REFUNDED
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  product IEOProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([productId])
  @@map("ieo_investments")
}

// ContractSessionControl: Control next session result (100% WIN/LOSS)
model ContractSessionControl {
  id        Int      @id @default(autoincrement())
  /// Final result for the controlled session: WIN or LOSS
  final     String
  /// Whether this control is active for the next session
  required  Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("contract_session_controls")
}

// MiningProduct: AI Mining products
model MiningProduct {
  id                 Int      @id @default(autoincrement())
  hashRate           String   @map("hash_rate") // 180MH/S, 540MH/S, ...
  currency           String   @default("USDT")
  averageDailyReturn Decimal  @map("average_daily_return") @db.Decimal(36, 18) // Percentage
  minimumPurchase    Decimal  @map("minimum_purchase") @db.Decimal(36, 18)
  maximumPurchase    Decimal? @map("maximum_purchase") @db.Decimal(36, 18)
  duration           Int      @default(30) // Duration in days
  status             String   @default("ACTIVE") // ACTIVE, INACTIVE, SOLD_OUT
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  investments MiningInvestment[]

  @@index([status])
  @@map("mining_products")
}

// MiningInvestment: User purchases of mining products
model MiningInvestment {
  id             Int       @id @default(autoincrement())
  userId         Int       @map("user_id")
  productId      Int       @map("product_id")
  amount         Decimal   @db.Decimal(36, 18) // Amount purchased
  hashRate       String    @map("hash_rate")
  dailyReturn    Decimal   @map("daily_return") @db.Decimal(36, 18) // Daily return amount
  totalReturn    Decimal   @default(0) @map("total_return") @db.Decimal(36, 18) // Accumulated returns
  startDate      DateTime  @map("start_date")
  endDate        DateTime  @map("end_date")
  status         String    @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  lastPayoutDate DateTime? @map("last_payout_date")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  product MiningProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([productId])
  @@index([status, endDate])
  @@map("mining_investments")
}

// WithdrawalRequest: yêu cầu rút tiền (manual review/processing)
model WithdrawalRequest {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  asset     String // USDT, BTC, ETH, ...
  chain     String // ERC20, TRC20, ...
  address   String
  amount    Decimal  @db.Decimal(36, 18) // amount user entered (includes fee)
  fee       Decimal  @db.Decimal(36, 18)
  arrival   Decimal  @db.Decimal(36, 18) // amount - fee
  status    String   @default("PENDING") // PENDING, APPROVED, SENT, REJECTED, CANCELED
  txHash    String?  @map("tx_hash")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, status])
  @@index([asset, chain, createdAt])
  @@map("withdrawal_requests")
}

// Transfer: chuyển tiền giữa Coins Account và Contract Account
model Transfer {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  asset       String // USDT, BTC, ETH, ...
  amount      Decimal  @db.Decimal(36, 18)
  fromAccount String   @map("from_account") // 'coins' | 'contract'
  toAccount   String   @map("to_account") // 'coins' | 'contract'
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([asset, createdAt])
  @@map("transfers")
}

// ExchangeTransaction: hoán đổi asset (swap) theo tỉ giá thị trường (market)
model ExchangeTransaction {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  fromAsset  String   @map("from_asset")
  toAsset    String   @map("to_asset")
  fromAmount Decimal  @map("from_amount") @db.Decimal(36, 18)
  toAmount   Decimal  @map("to_amount") @db.Decimal(36, 18) // net after fee
  rate       Decimal  @db.Decimal(36, 18) // conversion rate used
  feeAsset   String   @map("fee_asset")
  feeAmount  Decimal  @map("fee_amount") @db.Decimal(36, 18)
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([fromAsset, toAsset, createdAt])
  @@map("exchange_transactions")
}

// Conversation: Chat conversation between user and admin
model Conversation {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  status        String    @default("OPEN") // OPEN, CLOSED, RESOLVED
  lastMessageAt DateTime? @map("last_message_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId, createdAt])
  @@index([status, lastMessageAt])
  @@map("conversations")
}

// Message: Chat messages in conversations
model Message {
  id             Int      @id @default(autoincrement())
  conversationId Int      @map("conversation_id")
  senderId       Int      @map("sender_id") // User ID (can be user or admin, admin = 0)
  senderType     String   @map("sender_type") // 'user' | 'admin'
  content        String? // Text content (null if image only)
  imageUrl       String?  @map("image_url") // URL to uploaded image
  isRead         Boolean  @default(false) @map("is_read")
  createdAt      DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId, createdAt])
  @@map("messages")
}

// VerificationRequest: yêu cầu xác minh danh tính của user
model VerificationRequest {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  name         String // Tên trên CMND/CCCD
  idNumber     String    @map("id_number") // Số CMND/CCCD
  frontIdUrl   String    @map("front_id_url") // URL ảnh mặt trước
  backIdUrl    String    @map("back_id_url") // URL ảnh mặt sau
  status       String    @default("PENDING") // PENDING, APPROVED, REJECTED
  rejectReason String?   @map("reject_reason") // Lý do từ chối (nếu bị reject)
  reviewedBy   Int?      @map("reviewed_by") // Admin ID đã review (null nếu chưa review)
  reviewedAt   DateTime? @map("reviewed_at") // Thời gian review
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status, createdAt])
  @@map("verification_requests")
}

// DepositAddress: địa chỉ ví để user nạp tiền theo từng network
model DepositAddress {
  id        Int      @id @default(autoincrement())
  asset     String // USDT, USDC, BTC, ETH, ...
  network   String // ERC20, TRC20, Bitcoin, Bank Card, ...
  address   String // Địa chỉ ví hoặc thông tin ngân hàng (JSON string)
  qrCodeUrl String?  @map("qr_code_url") // URL QR code (nếu có)
  isActive  Boolean  @default(true) @map("is_active")
  minAmount Decimal? @map("min_amount") @db.Decimal(36, 18) // Số tiền tối thiểu
  maxAmount Decimal? @map("max_amount") @db.Decimal(36, 18) // Số tiền tối đa
  note      String? // Ghi chú cho user
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([asset, network])
  @@index([asset, network, isActive])
  @@map("deposit_addresses")
}

// DepositRequest: yêu cầu nạp tiền của user
model DepositRequest {
  id             Int       @id @default(autoincrement())
  userId         Int       @map("user_id")
  asset          String // USDT, USDC, BTC, ETH, ...
  network        String // ERC20, TRC20, Bitcoin, Bank Card, ...
  amount         Decimal   @db.Decimal(36, 18) // Số tiền nạp
  certificateUrl String?   @map("certificate_url") // URL ảnh chứng từ chuyển khoản
  status         String    @default("PENDING") // PENDING, APPROVED, REJECTED, COMPLETED
  rejectReason   String?   @map("reject_reason") // Lý do từ chối (nếu bị reject)
  reviewedBy     Int?      @map("reviewed_by") // Admin ID đã review (null nếu chưa review)
  reviewedAt     DateTime? @map("reviewed_at") // Thời gian review
  completedAt    DateTime? @map("completed_at") // Thời gian hoàn thành (khi đã cộng tiền)
  txHash         String?   @map("tx_hash") // Transaction hash (nếu có)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([asset, network])
  @@map("deposit_requests")
}
