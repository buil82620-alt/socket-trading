generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      Int                   @id @default(autoincrement())
  email                   String                @unique
  passwordHash            String                @map("password_hash")
  uid                     String?               @unique
  createdAt               DateTime              @default(now()) @map("created_at")
  transactionPasswordHash String?               @map("transaction_password_hash")
  banReason               String?               @map("ban_reason")
  bannedAt                DateTime?             @map("banned_at")
  isActive                Boolean               @default(true) @map("is_active")
  isBanned                Boolean               @default(false) @map("is_banned")
  isVerified              Boolean               @default(false) @map("is_verified")
  lastLoginAt             DateTime?             @map("last_login_at")
  updatedAt               DateTime              @updatedAt @map("updated_at")
  contractPositions       ContractPosition[]
  conversations           Conversation[]
  depositRequests         DepositRequest[]
  exchangeTransactions    ExchangeTransaction[]
  ieoInvestments          IEOInvestment[]
  miningInvestments       MiningInvestment[]
  orders                  SpotOrder[]
  tradeFills              TradeFill[]
  transfers               Transfer[]
  verificationRequests    VerificationRequest[]
  wallets                 Wallet[]
  withdrawalRequests      WithdrawalRequest[]

  @@map("users")
}

model Wallet {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  asset     String
  available Decimal  @db.Decimal(36, 18)
  locked    Decimal  @default(0) @db.Decimal(36, 18)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, asset])
  @@map("wallets")
}

model SpotOrder {
  id             Int         @id @default(autoincrement())
  userId         Int         @map("user_id")
  symbol         String
  side           String
  type           String
  price          Decimal?    @db.Decimal(36, 18)
  quantity       Decimal     @db.Decimal(36, 18)
  filledQuantity Decimal     @default(0) @db.Decimal(36, 18)
  status         String      @default("NEW")
  feeAsset       String?     @map("fee_asset")
  feeAmount      Decimal?    @default(0) @map("fee_amount") @db.Decimal(36, 18)
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  tradeFills     TradeFill[]

  @@index([userId, status])
  @@index([symbol, status])
  @@map("spot_orders")
}

model TradeFill {
  id        Int       @id @default(autoincrement())
  orderId   Int       @map("order_id")
  userId    Int       @map("user_id")
  symbol    String
  price     Decimal   @db.Decimal(36, 18)
  quantity  Decimal   @db.Decimal(36, 18)
  feeAsset  String    @map("fee_asset")
  feeAmount Decimal   @map("fee_amount") @db.Decimal(36, 18)
  side      String
  createdAt DateTime  @default(now()) @map("created_at")
  order     SpotOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([orderId])
  @@index([symbol, createdAt])
  @@map("trade_fills")
}

model ContractPosition {
  id             Int       @id @default(autoincrement())
  userId         Int       @map("user_id")
  symbol         String
  side           String
  entryPrice     Decimal   @map("entry_price") @db.Decimal(36, 18)
  amount         Decimal   @db.Decimal(36, 18)
  duration       Int
  profitability  Decimal   @db.Decimal(36, 18)
  expectedProfit Decimal   @map("expected_profit") @db.Decimal(36, 18)
  expectedPayout Decimal   @map("expected_payout") @db.Decimal(36, 18)
  status         String    @default("OPEN")
  exitPrice      Decimal?  @map("exit_price") @db.Decimal(36, 18)
  actualProfit   Decimal?  @map("actual_profit") @db.Decimal(36, 18)
  result         String?
  createdAt      DateTime  @default(now()) @map("created_at")
  expiresAt      DateTime  @map("expires_at")
  closedAt       DateTime? @map("closed_at")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([status, expiresAt])
  @@map("contract_positions")
}

model IEOProduct {
  id            Int             @id @default(autoincrement())
  title         String
  symbol        String
  status        String          @default("UPCOMING")
  totalSupply   Decimal         @map("total_supply") @db.Decimal(36, 18)
  currentRaised Decimal         @default(0) @map("current_raised") @db.Decimal(36, 18)
  pricePerToken Decimal         @map("price_per_token") @db.Decimal(36, 18)
  startDate     DateTime        @map("start_date")
  endDate       DateTime?       @map("end_date")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  investments   IEOInvestment[]

  @@index([status])
  @@index([startDate, endDate])
  @@map("ieo_products")
}

model IEOInvestment {
  id        Int        @id @default(autoincrement())
  userId    Int        @map("user_id")
  productId Int        @map("product_id")
  amount    Decimal    @db.Decimal(36, 18)
  tokens    Decimal    @db.Decimal(36, 18)
  status    String     @default("PENDING")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  product   IEOProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([productId])
  @@map("ieo_investments")
}

model MiningProduct {
  id                 Int                @id @default(autoincrement())
  hashRate           String             @map("hash_rate")
  currency           String             @default("USDT")
  averageDailyReturn Decimal            @map("average_daily_return") @db.Decimal(36, 18)
  minimumPurchase    Decimal            @map("minimum_purchase") @db.Decimal(36, 18)
  maximumPurchase    Decimal?           @map("maximum_purchase") @db.Decimal(36, 18)
  duration           Int                @default(30)
  status             String             @default("ACTIVE")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  investments        MiningInvestment[]

  @@index([status])
  @@map("mining_products")
}

model MiningInvestment {
  id             Int           @id @default(autoincrement())
  userId         Int           @map("user_id")
  productId      Int           @map("product_id")
  amount         Decimal       @db.Decimal(36, 18)
  hashRate       String        @map("hash_rate")
  dailyReturn    Decimal       @map("daily_return") @db.Decimal(36, 18)
  totalReturn    Decimal       @default(0) @map("total_return") @db.Decimal(36, 18)
  startDate      DateTime      @map("start_date")
  endDate        DateTime      @map("end_date")
  status         String        @default("ACTIVE")
  lastPayoutDate DateTime?     @map("last_payout_date")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  product        MiningProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([productId])
  @@index([status, endDate])
  @@map("mining_investments")
}

model WithdrawalRequest {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  asset     String
  chain     String
  address   String
  amount    Decimal  @db.Decimal(36, 18)
  fee       Decimal  @db.Decimal(36, 18)
  arrival   Decimal  @db.Decimal(36, 18)
  status    String   @default("PENDING")
  txHash    String?  @map("tx_hash")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, status])
  @@index([asset, chain, createdAt])
  @@map("withdrawal_requests")
}

model Transfer {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  asset       String
  amount      Decimal  @db.Decimal(36, 18)
  fromAccount String   @map("from_account")
  toAccount   String   @map("to_account")
  createdAt   DateTime @default(now()) @map("created_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([asset, createdAt])
  @@map("transfers")
}

model ExchangeTransaction {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  fromAsset  String   @map("from_asset")
  toAsset    String   @map("to_asset")
  fromAmount Decimal  @map("from_amount") @db.Decimal(36, 18)
  toAmount   Decimal  @map("to_amount") @db.Decimal(36, 18)
  rate       Decimal  @db.Decimal(36, 18)
  feeAsset   String   @map("fee_asset")
  feeAmount  Decimal  @map("fee_amount") @db.Decimal(36, 18)
  createdAt  DateTime @default(now()) @map("created_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([fromAsset, toAsset, createdAt])
  @@map("exchange_transactions")
}

model Conversation {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  status        String    @default("OPEN")
  lastMessageAt DateTime? @map("last_message_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@index([userId, createdAt])
  @@index([status, lastMessageAt])
  @@map("conversations")
}

model Message {
  id             Int          @id @default(autoincrement())
  conversationId Int          @map("conversation_id")
  senderId       Int          @map("sender_id")
  senderType     String       @map("sender_type")
  content        String?
  imageUrl       String?      @map("image_url")
  isRead         Boolean      @default(false) @map("is_read")
  createdAt      DateTime     @default(now()) @map("created_at")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId, createdAt])
  @@map("messages")
}

model Admin {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("admins")
}

model VerificationRequest {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  name         String
  idNumber     String    @map("id_number")
  frontIdUrl   String    @map("front_id_url")
  backIdUrl    String    @map("back_id_url")
  status       String    @default("PENDING")
  rejectReason String?   @map("reject_reason")
  reviewedBy   Int?      @map("reviewed_by")
  reviewedAt   DateTime? @map("reviewed_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status, createdAt])
  @@map("verification_requests")
}

// Verification codes for email validation
model VerificationCode {
  id        Int      @id @default(autoincrement())
  email     String
  code      String
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email, createdAt])
  @@map("verification_codes")
}

model DepositRequest {
  id             Int       @id @default(autoincrement())
  userId         Int       @map("user_id")
  asset          String
  network        String
  amount         Decimal   @db.Decimal(36, 18)
  certificateUrl String?   @map("certificate_url")
  status         String    @default("PENDING")
  rejectReason   String?   @map("reject_reason")
  reviewedBy     Int?      @map("reviewed_by")
  reviewedAt     DateTime? @map("reviewed_at")
  completedAt    DateTime? @map("completed_at")
  txHash         String?   @map("tx_hash")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([asset, network])
  @@map("deposit_requests")
}

model DepositAddress {
  id        Int      @id @default(autoincrement())
  asset     String
  network   String
  address   String
  qrCodeUrl String?  @map("qr_code_url")
  isActive  Boolean  @default(true) @map("is_active")
  minAmount Decimal? @map("min_amount") @db.Decimal(36, 18)
  maxAmount Decimal? @map("max_amount") @db.Decimal(36, 18)
  note      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([asset, network])
  @@index([asset, network, isActive])
  @@map("deposit_addresses")
}

// ContractSessionControl: Control next contract sessions result (WIN/LOSS queue)
model ContractSessionControl {
  id        Int      @id @default(autoincrement())
  final     String
  required  Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("contract_session_controls")
}

